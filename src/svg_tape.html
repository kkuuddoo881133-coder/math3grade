<script>
(function (SVG) {
  // テープ（定規）を描く共通関数
  function renderTape(opts){
    // 設定
    var cmTotal = opts.cm || 6;          // 何cmぶん表示するか
    var pxPerCm = opts.scale || 60;      // 1cmの横幅(px) → 1mm=pxPerCm/10
    var mmStep  = pxPerCm / 10;
    var PAD = 28;                         // 左右の余白
    var W = Math.round(cmTotal * pxPerCm + PAD*2);
    var H = opts.height || 120;
    var baseY = 60;                       // テープのベースY
    var tapeH = 18;

    var svg = SVG.svg(W, H);

    // テープ本体
    svg.appendChild(SVG.el('rect', {
      x: PAD, y: baseY - tapeH/2, width: cmTotal*pxPerCm, height: tapeH,
      rx: 3, ry: 3, fill: '#f9fafb', stroke: '#374151'
    }));

    // 目盛り（1mm / 5mm / 10mm=1cm）
    for (var mm = 0; mm <= cmTotal*10; mm++){
      var x = PAD + mm * mmStep;
      var len = (mm%10===0) ? 16 : (mm%5===0) ? 10 : 6;
      var y1 = baseY - tapeH/2; // テープ上辺
      svg.appendChild(SVG.el('line', {x1:x, y1:y1, x2:x, y2:y1 - len, stroke:'#111'}));
      // cmラベル
      if (mm%10===0){
        var cm = mm/10;
        svg.appendChild(SVG.text(x, y1 - 22, (cm===0?'0':cm+'cm'), {'font-size':11, fill:'#111'}));
      }
    }

    // 0の表示（左端）
    svg.appendChild(SVG.text(PAD, baseY - 22, '0', {'font-size':11, fill:'#111', 'text-anchor':'start'}));

    // 単色の塗り（0 から shadeCm まで）
    if (typeof opts.shadeCm === 'number'){
      var w = Math.max(0, Math.min(opts.shadeCm, cmTotal))*pxPerCm;
      svg.appendChild(SVG.el('rect', {
        x: PAD, y: baseY - tapeH/2 + 2, width: w, height: tapeH - 4,
        rx: 2, ry: 2, fill: '#bfdbfe'
      }));
    }

    // 複数セグメント塗り
    if (Array.isArray(opts.shadeSegments)){
      opts.shadeSegments.forEach(function(seg){
        var from = Math.max(0, Math.min(seg.from, cmTotal));
        var to   = Math.max(0, Math.min(seg.to, cmTotal));
        if (to <= from) return;
        svg.appendChild(SVG.el('rect', {
          x: PAD + from*pxPerCm,
          y: baseY - tapeH/2 + 2,
          width: (to-from)*pxPerCm,
          height: tapeH - 4,
          rx: 2, ry: 2,
          fill: seg.color || '#bfdbfe'
        }));
      });
    }

    // セグメント注記（かっこ代わりのガイド＋テキスト）
    if (Array.isArray(opts.segmentNotes)){
      opts.segmentNotes.forEach(function(n){
        var x1 = PAD + n.from*pxPerCm, x2 = PAD + n.to*pxPerCm;
        var mid = (x1 + x2)/2;
        var topY = baseY - tapeH/2 - 30;
        // ガイド（括弧）
        svg.appendChild(SVG.el('line', {x1:x1, y1:topY, x2:x1, y2:topY+10, stroke:'#2563eb'}));
        svg.appendChild(SVG.el('line', {x1:x1, y1:topY, x2:x2, y2:topY, stroke:'#2563eb'}));
        svg.appendChild(SVG.el('line', {x1:x2, y1:topY, x2:x2, y2:topY+10, stroke:'#2563eb'}));
        // テキスト
        svg.appendChild(SVG.text(mid, topY - 6, n.text, {'font-size':12, fill:'#2563eb'}));
      });
    }

    // ピン（候補位置）：三角マーカーを “上側” に、ラベルは “下側” に出す（目盛りにかぶらない）
    if (Array.isArray(opts.pinsCm)){
      var labels = opts.labels || [];
      opts.pinsCm.forEach(function(cmPos, i){
        var X = PAD + cmPos*pxPerCm;
        var triY = baseY - tapeH/2 - 2;            // テープ上辺の少し上
        var tri = [
          [X, triY-10], [X-6, triY], [X+6, triY]
        ];
        // 三角形
        svg.appendChild(SVG.el('polygon', {
          points: tri.map(function(p){return p.join(',');}).join(' '),
          fill: '#2563eb'
        }));
        // 細い縦線（上から指す感じで、目盛りは避けて短く）
        svg.appendChild(SVG.el('line', {x1:X, y1:triY-10, x2:X, y2:triY-14, stroke:'#2563eb', 'stroke-width':2}));

        // ラベル（下側）
        var label = labels[i] || '';
        if (label){
          svg.appendChild(SVG.text(X, baseY + tapeH/2 + 22, label, {'font-size':12, fill:'#2563eb'}));
        }
      });
    }

    return svg;
  }

  // ===== 個別アセット =====

  // 1108/1109：読みとり（3cm5mm = 3.5cm）
  // 0 〜 5cm のテープに、0→3.5cm を水色で塗り
  function tape_dec_read_35mm(){
    return renderTape({cm:5, shadeCm:3.5});
  }

  // 1110：合成（1cmが3つ、0.1cmが7つ → 3.7cm）
  // 0→3cm 濃い水色、3→3.7cm 薄い水色、上に「1cm×3」「0.1cm×7」の注記
  function tape_dec_blocks_3cm_7tenths(){
    return renderTape({
      cm:5,
      shadeSegments: [
        {from:0, to:3,   color:'#93c5fd'},
        {from:3, to:3.7, color:'#bfdbfe'}
      ],
      segmentNotes: [
        {from:0, to:3,   text:'1cm × 3'},
        {from:3, to:3.7, text:'0.1cm × 7'}
      ]
    });
  }

  // 1111：指定位置（4.8cm）
  // 候補は ア=4.7, イ=4.8(正解), ウ=4.9, エ=5.0
  function tape_dec_shade_4_8(){
    return renderTape({
      cm:6,
      pinsCm: [4.7, 4.8, 4.9, 5.0],
      labels: ['ア','イ','ウ','エ']
    });
  }

  // レジストリ登録
  SVG.register(function(spec){
    if (spec === 'tape_dec_read_35mm' || spec === 'tape:dec_read_35mm') return tape_dec_read_35mm();
    if (spec === 'tape_dec_blocks_3cm_7tenths' || spec === 'tape:dec_blocks_3cm_7tenths') return tape_dec_blocks_3cm_7tenths();
    if (spec === 'tape_dec_shade_4_8' || spec === 'tape:dec_shade_4_8') return tape_dec_shade_4_8();
    return null;
  });
})(window.SVG);
</script>
