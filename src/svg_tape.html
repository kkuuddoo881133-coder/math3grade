<script>
// == Tape (ruler) assets: cm/mm ==
(function (SVG) {
  function renderTape(opts){
    var W = opts.width  || 640;
    var H = opts.height || 160;
    var pad = {l:42, r:18, t:28, b:56};      // 下に▲とラベルを置く
    var svg = SVG.svg(W, H);

    var cmStart = opts.cmStart ?? 0;
    var cmEnd   = opts.cmEnd   ?? 6;

    var railX = pad.l, railW = W - pad.l - pad.r;
    var railTopY = pad.t;
    var trayY = railTopY + 26, trayH = 24;

    // トレー
    svg.appendChild(SVG.el('rect', {
      x:railX, y:trayY, width:railW, height:trayH, rx:10, ry:10,
      fill:'#f9fafb', stroke:'#374151', 'stroke-width':1.6
    }));

    // 目盛り
    var totalMm = (cmEnd - cmStart) * 10;  // 1目盛=1mm
    var pxPerMm = railW / totalMm;

    for (var i=0; i<=totalMm; i++){
      var x = railX + i * pxPerMm;
      var len = 8;                               // 1mm
      if (i % 10 === 0) len = 20;                // 1cm
      else if (i % 5 === 0) len = 13;            // 5mm

      svg.appendChild(SVG.el('line', {x1:x, y1:railTopY, x2:x, y2:railTopY+len, stroke:'#111'}));

      // cmラベル（上）—0 は最初だけ
      if (i % 10 === 0){
        var cm = cmStart + i/10;
        var label = (cm===0) ? '0' : (cm + 'cm');
        svg.appendChild(SVG.text(x, railTopY-6, label, {'font-size':12, fill:'#111', 'text-anchor':'middle'}));
      }
    }

    // 読み取り帯（任意）
    if (opts.readMm != null){
      var w = Math.max(0, Math.min(railW, opts.readMm * pxPerMm));
      svg.appendChild(SVG.el('rect', {
        x:railX+2, y:trayY+2, width:Math.max(0, w-4), height:trayH-4, rx:8, ry:8, fill:'#c7e0fe'
      }));
    }

    // 合成ブロック（任意）
    if (opts.blocks && opts.blocks.length){
      var by = railTopY + 6;
      opts.blocks.forEach(function(b){
        var x0 = railX + b.startMm * pxPerMm;
        var x1 = railX + b.endMm   * pxPerMm;
        svg.appendChild(SVG.el('rect', {x:x0, y:by, width:(x1-x0), height:10, rx:2, ry:2, fill:b.fill || '#93c5fd'}));
      });
      if (opts.blocksNote){
        svg.appendChild(SVG.text(W-8, by-6, opts.blocksNote, {'font-size':11, fill:'#374151', 'text-anchor':'end'}));
      }
    }

    // 位置選択 ▲（下側）
    if (opts.picks && opts.picks.length){
      var markY = trayY + trayH + 20;
      var triH = 14, triW = 8;
      opts.picks.forEach(function(p){
        var x = railX + p.mm * pxPerMm;
        var d = ['M', x, markY, 'l', triW, 0, 'l', -triW, -triH, 'z'].join(' ');
        svg.appendChild(SVG.el('path', {d:d, fill:'#2563eb'}));
      });
      if (opts.pickLabel){
        var leftX  = railX + (opts.picks[0].mm) * pxPerMm;
        var rightX = railX + (opts.picks[opts.picks.length-1].mm) * pxPerMm + triW;
        var cx = (leftX + rightX) / 2;
        svg.appendChild(SVG.text(cx, markY+22, opts.pickLabel, {'font-size':16, fill:'#2563eb', 'text-anchor':'middle'}));
      }
    }
    return svg;
  }

  // --- Assets ---
  // 1108/1109: 読み取り（3cm5mm）
  SVG.register(function(spec){
    if (spec === 'tape_dec_read_35mm' || spec === 'svg:tape_dec_read_35mm'){
      return renderTape({cmStart:0, cmEnd:5, readMm:35});
    }
    return null;
  });

  // 1110: 合成 3cm + 0.1cm×7 = 3.7cm
  SVG.register(function(spec){
    if (spec === 'tape_dec_blocks_3cm_7tenths' || spec === 'svg:tape_dec_blocks_3cm_7tenths'){
      var blocks = [];
      blocks.push({startMm:0, endMm:10, fill:'#bae6fd'});
      blocks.push({startMm:10, endMm:20, fill:'#bae6fd'});
      blocks.push({startMm:20, endMm:30, fill:'#bae6fd'});
      for (var m=30; m<37; m++) blocks.push({startMm:m, endMm:m+1, fill:'#93c5fd'});
      return renderTape({cmStart:0, cmEnd:5, readMm:37, blocks:blocks, blocksNote:'1cm×3 と 0.1cm×7'});
    }
    return null;
  });

  // 1111: 位置指定（4.8cm）▲を下側に並べ、下に「アイウエ」
  SVG.register(function(spec){
    if (spec === 'tape_dec_shade_4_8' || spec === 'svg:tape_dec_shade_4_8'){
      return renderTape({
        cmStart:0, cmEnd:6,
        picks:[{mm:47},{mm:48},{mm:49},{mm:50}],
        pickLabel:'アイウエ'
      });
    }
    return null;
  });
})(window.SVG);
</script>
