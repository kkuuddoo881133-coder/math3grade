<script>
(function (SVG) {
  function renderRuler(totalCm, pins, labels, opt){
    opt = opt || {};
    var PAD=18, W = totalCm + PAD*2, H=80, baseY=40;
    var TICK_LONG=18, TICK_MID=14, TICK_SHORT=9; // 100/50/10cm
    var PIN_GAP = opt.pinGap || 6;      // 最長目盛からの余白
    var PIN_H   = opt.pinHeight || 8;   // ピンの高さ
    var PIN_STYLE = opt.pinStyle || 'line'; // 'line' or 'dot'

    var svg = SVG.svg(W,H);

    // 本体バー
    svg.appendChild(SVG.rect
      ? SVG.rect(PAD, baseY, totalCm, 8, 0, 0, {fill:'#f9fafb', stroke:'#374151'})
      : SVG.el('rect',{x:PAD,y:baseY,width:totalCm,height:8,fill:'#f9fafb',stroke:'#374151'}));

    // 目盛り（10/50/100cm）
    for (var x=0; x<=totalCm; x+=10){
      var len = (x%100===0)?TICK_LONG:(x%50===0)?TICK_MID:TICK_SHORT;
      svg.appendChild(SVG.line(PAD+x, baseY, PAD+x, baseY-len, {stroke:'#111'}));
      if (x%100===0 && x>0){
        svg.appendChild(SVG.text(PAD+x, baseY-24, (x/100)+'m', {'font-size':10, fill:'#111'}));
      }
    }
    // 0 の表示
    svg.appendChild(SVG.text(PAD, baseY-24, '0', {'font-size':10, fill:'#111', 'text-anchor':'start'}));

    // —— ここが変更点：ピンは「最長目盛のさらに上」に配置 ——
    // 最長目盛の頂点：baseY - TICK_LONG
    var pinTop    = (baseY - TICK_LONG) - PIN_GAP - PIN_H; // ピン上端
    var pinBottom = pinTop + PIN_H;                        // ピン下端（=最長目盛より上）

    // ピン＆ラベル
    pins = pins || [];
    labels = labels || [];
    pins.forEach(function(px, i){
      var X = PAD + px;
      if (PIN_STYLE === 'dot'){
        // 小さな丸ピン
        svg.appendChild(SVG.circle
          ? SVG.circle(X, pinTop + PIN_H/2, 3, {fill:'#2563eb'})
          : SVG.el('circle',{cx:X, cy:pinTop + PIN_H/2, r:3, fill:'#2563eb'}));
      }else{
        // 細い縦線ピン（目盛と非接触）
        svg.appendChild(SVG.line(X, pinTop, X, pinBottom, {stroke:'#2563eb','stroke-width':2}));
      }
      var label = labels[i] || '';
      if (label){
        svg.appendChild(SVG.text(X, baseY+26, label, {'font-size':12, fill:'#2563eb'}));
      }
    });

    return svg;
  }

  function parse(spec){
    // e.g. "ruler-350-280-300-330|labels:ア,イ,ウ|pin:dot"
    var parts = spec.split('|');
    var head = parts[0].split('-');
    if (head[0] !== 'ruler') return null;
    var total = parseInt(head[1]||120,10);
    var pins  = head.slice(2).map(function(v){ return parseInt(v,10); }).filter(function(n){ return isFinite(n); });
    var labels = [];
    var opt = {};
    parts.slice(1).forEach(function(p){
      if (p.indexOf('labels:')===0) labels = p.slice(7).split(',').map(function(s){ return s.trim(); });
      if (p.indexOf('pin:')===0)    opt.pinStyle = p.slice(4).trim(); // 'line' or 'dot'
    });
    return { total: total, pins: pins, labels: labels, opt: opt };
  }

  SVG.register(function(spec){
    var p = parse(spec);
    if (!p) return null;
    return renderRuler(p.total, p.pins, p.labels, p.opt);
  });
})(window.SVG);
</script>
