<script>
// ===== 画面切替（show の衝突回避で showScreen に統一） =====
function showScreen(id) {
  var S = {
    login:  document.getElementById('screen-login'),
    home:   document.getElementById('screen-home'),
    quiz:   document.getElementById('screen-quiz'),
    result: document.getElementById('screen-result'),
    summary:document.getElementById('screen-summary')
  };
  for (var k in S) { if (S[k]) S[k].classList.remove('active'); }
  if (S[id]) S[id].classList.add('active');
}

// ===== ユーティリティ =====
function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
function formatUnitsHTML(s){
  var x = escapeHTML(s);
  x = x.replace(/２/g,'2').replace(/３/g,'3').replace(/＾/g,'^');
  x = x
    .replace(/㎠/g, 'cm<sup>2</sup>')
    .replace(/㎤/g, 'cm<sup>3</sup>')
    .replace(/cm²/gi, 'cm<sup>2</sup>')
    .replace(/cm³/gi, 'cm<sup>3</sup>')
    .replace(/ｃｍ²/gi, 'cm<sup>2</sup>')
    .replace(/ｃｍ³/gi, 'cm<sup>3</sup>');
  x = x.replace(/(cm|mm|m)\s*[\^＾]\s*2/gi, '$1<sup>2</sup>')
       .replace(/(cm|mm|m)\s*[\^＾]\s*3/gi, '$1<sup>3</sup>')
       .replace(/(cm|mm|m)\s*2(?!\d)/gi, '$1<sup>2</sup>')
       .replace(/(cm|mm|m)\s*3(?!\d)/gi, '$1<sup>3</sup>');
  return x;
}
// 互換ヘルパ
function safeValue(el){ return (el && typeof el.value === 'string') ? el.value.trim() : ''; }
function safeMsg(err){ return (err && err.message) ? err.message : String(err); }
function safeGet(arr, i){ return (arr && arr.length > i && arr[i] != null) ? arr[i] : ''; }

function buildResultOptionHTML(letter, rawText, extraClasses) {
  var classes = ['result-option'];
  if (Array.isArray(extraClasses)) {
    for (var i = 0; i < extraClasses.length; i++) {
      if (extraClasses[i]) classes.push(extraClasses[i]);
    }
  }
  return '<div class="' + classes.join(' ') + '">' +
           '<div class="result-option-label">' + escapeHTML(letter || '') + '</div>' +
           '<div class="result-option-text">' + formatUnitsHTML(rawText || '') + '</div>' +
         '</div>';
}

// ===== 状態 =====
var state = {
  user_id: null, nickname: null, pin: null,
  domains: [],
  session: { items: [], idx: 0, selected: null, correctCount: 0, startedAt: 0, lastResult: null }
};

var domainLoadState = {
  active: false,
  domain: null,
  element: null,
  source: null
};

// === 正解位置の表示モード ===
// 'as_is'  : 並べ替えなし（シート通り。今はこれで運用）
// 'shuffle': 毎問ランダム並べ替え
// 'force_C': 表示上は常にCが正解
// 'cycle'  : A→B→C→Dと巡回で正解位置を分散
const ANSWER_POSITION_MODE = 'shuffle';
const DAILY_ACTIVITY_WINDOW = 42; // 6週間（7×6グリッド）

let _cycleNextIndex = 0; // cycle用カウンタ（0:A,1:B,2:C,3:D）

// 正解位置モードに応じた並べ替え（perm: 0..3 が A..D を指す）
function buildChoicePermutation(originalCorrectLetter) {
  const labels = ['A','B','C','D'];
  const correctIdx = labels.indexOf(String(originalCorrectLetter || 'A').toUpperCase());
  let perm = [0,1,2,3];

  if (ANSWER_POSITION_MODE === 'as_is') return perm;

  if (ANSWER_POSITION_MODE === 'shuffle') {
    for (let i = perm.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [perm[i], perm[j]] = [perm[j], perm[i]];
    }
    return perm;
  }

  if (ANSWER_POSITION_MODE === 'force_C') {
    const target = 2; // Cの位置
    perm = perm.filter(i => i !== correctIdx);
    perm.splice(target, 0, correctIdx);
    return perm;
  }

  if (ANSWER_POSITION_MODE === 'cycle') {
    const target = _cycleNextIndex % 4; // 0:A,1:B,2:C,3:D
    _cycleNextIndex++;
    perm = perm.filter(i => i !== correctIdx);
    perm.splice(target, 0, correctIdx);
    return perm;
  }

  return perm;
}

// 各問題に「表示↔元のレター」対応表と表示用choicesを付与
function attachChoiceMapping(q) {
  const labels = ['A','B','C','D'];
  const perm = buildChoicePermutation(q.correct);
  // 表示用選択肢
  q.shuffledChoices = perm.map(i => q.choices[i]);
  // 表示 index(0..3) → 元のレター（A..D）
  q.displayToOriginal = perm.map(i => labels[i]);
  // 元のレター（A..D）→ 表示 index(0..3)
  q.originalToDisplay = {};
  perm.forEach((i, dispIdx) => { q.originalToDisplay[labels[i]] = dispIdx; });
}


// ===== 要素参照 =====
var stemEl, assetEl, choicesEl, progressEl, skillLabelEl, submitBtn, startAnyBtn;
var resultTextEl, reasonsEl, resultDetailEl, resultStemEl,
    resultLearnerCardEl, resultLearnerChoiceEl,
    resultCorrectCardEl, resultCorrectChoiceEl,
    resultOtherCardEl, resultOtherChoicesEl;

// ===== Login処理（堅牢・段階ログ） =====
function handleLoginClick() {
  var nicknameEl = document.getElementById('nickname');
  var pinEl = document.getElementById('pin');
  var btn = document.getElementById('loginBtn');
  var orig = btn ? btn.textContent : '';
  if (btn) { btn.disabled = true; btn.textContent = '接続中…'; }

  state.nickname = safeValue(nicknameEl) || 'guest';
  state.pin = safeValue(pinEl) || '0000';
  state.user_id = state.nickname + '#' + state.pin;
  try { localStorage.setItem('user_id', state.user_id); } catch(_){}

  var done = false;
  function finish(){
    if (done) return;
    done = true;
    if (btn) { btn.disabled = false; btn.textContent = orig; }
  }

  var watchdog = setTimeout(function(){
    try { renderDomains(); } catch(_){}
    showScreen('home');
    finish();
  }, 8000);

  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    clearTimeout(watchdog);
    finish();
    return;
  }

  google.script.run
    .withFailureHandler(function(err){
      state.domains = [];
      try { renderDomains(); } catch(e){ console.error('renderDomains error', e); }
      showScreen('home');
      var h = document.getElementById('health');
      if (h) h.textContent = 'ドメイン取得エラー: ' + safeMsg(err);
      clearTimeout(watchdog);
      finish();
    })
    .withSuccessHandler(function(domains){
      state.domains = Array.isArray(domains) ? domains : [];
      try { renderDomains(); } catch(e){ console.error('renderDomains error', e); }
      showScreen('home');

      google.script.run
        .withFailureHandler(function(err){
          console.error('healthCheck failed', err);
          var h = document.getElementById('health');
          if (h) h.textContent = '接続OK / スプレッドシートNG: ' + safeMsg(err);
        })
        .withSuccessHandler(function(info){
          var h = document.getElementById('health');
          if (h) h.textContent = '接続OK / Questions:' + info.hasQuestions + ' / Responses:' + info.hasResponses;
        })
        .healthCheck();

      clearTimeout(watchdog);
      finish();
    })
    .getDomains();
}

// ===== ドメイン読込 =====
function loadDomains() {
  google.script.run
    .withSuccessHandler(function(domains){
      state.domains = Array.isArray(domains) ? domains : [];
      try { renderDomains(); } catch (e) { console.error('renderDomains error', e); }
      showScreen('home');
    })
    .withFailureHandler(function(err){
      console.error('loadDomains failed', err);
      state.domains = [];
      try { renderDomains(); } catch(e){ console.error('renderDomains error', e); }
      showScreen('home');
    })
    .getDomains();
}

function setDomainCardsBusy(isBusy, activeCard) {
  var box = document.getElementById('domains');
  if (!box) return;
  if (isBusy) {
    box.setAttribute('data-loading', 'true');
  } else {
    box.removeAttribute('data-loading');
  }
  var cards = box.querySelectorAll('.card');
  for (var i = 0; i < cards.length; i++) {
    var card = cards[i];
    if (isBusy && card !== activeCard) {
      card.setAttribute('aria-disabled', 'true');
    } else {
      card.removeAttribute('aria-disabled');
    }
  }
}

function beginDomainLoading(domain, element, source) {
  if (domainLoadState.active) return false;
  domainLoadState.active = true;
  domainLoadState.domain = String(domain == null ? '' : domain);
  domainLoadState.element = element || null;
  domainLoadState.source = source || 'card';

  if (element && element.classList) {
    if (domainLoadState.source === 'card') {
      element.classList.add('is-loading');
      element.classList.add('is-selected');
    }
    element.setAttribute('aria-busy', 'true');
  }

  setDomainCardsBusy(true, domainLoadState.source === 'card' ? element : null);

  if (startAnyBtn) {
    startAnyBtn.disabled = true;
    startAnyBtn.setAttribute('aria-disabled', 'true');
    if (startAnyBtn !== element) {
      startAnyBtn.classList.remove('is-loading');
      startAnyBtn.removeAttribute('aria-busy');
    }
  }
  if (element && element === startAnyBtn) {
    startAnyBtn.classList.add('is-loading');
    startAnyBtn.setAttribute('aria-busy', 'true');
  }

  return true;
}

function clearDomainLoading() {
  if (!domainLoadState.active) return;
  setDomainCardsBusy(false);

  if (domainLoadState.element && domainLoadState.element.classList) {
    domainLoadState.element.classList.remove('is-loading');
    if (domainLoadState.source === 'card') {
      domainLoadState.element.classList.remove('is-selected');
    }
    domainLoadState.element.removeAttribute('aria-busy');
  }

  if (startAnyBtn) {
    startAnyBtn.disabled = false;
    startAnyBtn.removeAttribute('aria-disabled');
    startAnyBtn.classList.remove('is-loading');
    startAnyBtn.removeAttribute('aria-busy');
  }

  domainLoadState.active = false;
  domainLoadState.domain = null;
  domainLoadState.element = null;
  domainLoadState.source = null;
}

function handleDomainSelection(domain, element) {
  var source = (element && element === startAnyBtn) ? 'any' : 'card';
  if (!beginDomainLoading(domain, element, source)) return;
  startQuiz(domain);
}

// ===== ドメイン描画 =====
function renderDomains() {
  var box = document.getElementById('domains');
  if (!box) return;
  box.innerHTML = '';
  var list = state.domains || [];
  for (var i=0;i<list.length;i++){
    var d = list[i];
    var div = document.createElement('div');
    div.className = 'card';
    div.setAttribute('data-domain', String(d == null ? '' : d));
    div.innerHTML = '<strong>' + escapeHTML(d) + '</strong>';
    (function(domain, el){
      el.addEventListener('click', function(){
        if (domainLoadState.active) return;
        handleDomainSelection(domain, el);
      });
    })(d, div);

    if (domainLoadState.active && domainLoadState.source === 'card' && domainLoadState.domain === String(d == null ? '' : d)) {
      domainLoadState.element = div;
      div.classList.add('is-loading');
      div.classList.add('is-selected');
      div.setAttribute('aria-busy', 'true');
    }
    box.appendChild(div);
  }

  if (domainLoadState.active) {
    setDomainCardsBusy(true, domainLoadState.source === 'card' ? domainLoadState.element : null);
  } else {
    setDomainCardsBusy(false);
  }
}

// ===== 出題〜採点 =====
function startQuiz(domain) {
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    clearDomainLoading();
    console.error('startQuiz: google.script.run is unavailable');
    return;
  }

  google.script.run
    .withSuccessHandler(function(items){
      clearDomainLoading();
      state.session.items = items || [];
      (state.session.items || []).forEach(q => attachChoiceMapping(q));
      state.session.idx = 0;
      state.session.correctCount = 0;
      showQuestion();
      showScreen('quiz');
    })
    .withFailureHandler(function(err){
      clearDomainLoading();
      console.error('getQuestions failed', err);
    })
    // ★ 認可に必要な user_id を必ず渡す
    .getQuestions({ domain: domain, limit: 50, order: 'sequential', user_id: state.user_id });
}

function showQuestion() {
  var q = state.session.items[state.session.idx];
  if (!q) { return; }

  state.session.selected = null;
  state.session.startedAt = Date.now();

  if (progressEl)    progressEl.textContent = (state.session.idx + 1) + ' / ' + state.session.items.length;
  if (skillLabelEl)  skillLabelEl.textContent = 'スキル：' + (q && q.skill ? q.skill : '');
  if (stemEl)        stemEl.innerHTML = formatUnitsHTML((q && q.stem) ? q.stem : '');
  renderAsset(q ? q.assets : '');

  if (choicesEl) {
    choicesEl.innerHTML = '';
    var keys = ['A','B','C','D'];
    for (var i=0;i<4;i++){
      var key = keys[i];
      var text = formatUnitsHTML(safeGet(q && q.shuffledChoices, i) || '');
      var btn = document.createElement('button');
      btn.className = 'choice';
      btn.type = 'button';
      btn.setAttribute('data-key', key);
      // ★ ARIA：ラジオボタン相当の意味付け
      btn.setAttribute('role', 'radio');
      btn.setAttribute('aria-checked', 'false');
      btn.innerHTML = '(' + key + ') ' + text;
      choicesEl.appendChild(btn);
    }
  }

  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-disabled');
    submitBtn.setAttribute('aria-disabled', 'true');
  }
}

// ===== アセット描画 =====
function renderAsset(id) {
  if (!assetEl) return;
  var rawId = String(id || '').trim();
  assetEl.innerHTML = '';
  if (!rawId) return;

  var normalized = rawId.replace(/：/g, ':').replace(/[－ー]/g, '-').toLowerCase();
  if (!normalized) return;

  function normalizeImageUrl(raw){
    var url = String(raw || '').trim();
    if (url.toLowerCase().indexOf('img:') === 0) url = url.slice(4).trim();

    if (/^(data:|https?:\/\/)/i.test(url)) {
      var m = url.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//i);
      if (m && m[1]) return 'https://drive.google.com/uc?export=view&id=' + m[1];
      return url;
    }
    var g = url.match(/^gdrive:([\w-]+)$/i);
    if (g && g[1]) return 'https://drive.google.com/uc?export=view&id=' + g[1];
    return url; // 相対パス等
  }

  // --- 追加：モジュール化されたSVGレンダラーを先に試す ---
  if (normalized.indexOf('svg:') === 0 && window.SVG && Array.isArray(window.SVG._renderers)) {
    var spec = normalized.slice(4);
    for (var i = 0; i < window.SVG._renderers.length; i++) {
      try {
        var node = window.SVG._renderers[i](spec);
        if (node) { assetEl.appendChild(node); return; }
      } catch(e) { /* 個別レンダラーの例外は握りつぶし */ }
    }
  }
  // --- ここまで ---
  if (normalized.indexOf('img:') === 0) {
    var raw = rawId.slice(4).trim(); // 大文字ラベル保持
    var url = normalizeImageUrl(raw);

    var img = document.createElement('img');
    img.src = url;
    img.alt = '図';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '8px 0';
    img.onerror = function(){
      var note = document.createElement('div');
      note.textContent = '画像を読み込めませんでした：' + url;
      note.style.fontSize = '0.9em';
      note.style.color = '#b00';
      assetEl.innerHTML = '';
      assetEl.appendChild(note);
    };
    assetEl.appendChild(img);
  }
}



// ===== 初期化 =====
function initUI() {
  // 要素参照
  stemEl       = document.getElementById('stem');
  assetEl      = document.getElementById('asset');
  choicesEl    = document.getElementById('choices');
  progressEl   = document.getElementById('progress');
  skillLabelEl = document.getElementById('skillLabel');
  submitBtn    = document.getElementById('submitBtn');

  var resultScreen = document.getElementById('screen-result');
  if (resultScreen && !resultScreen.querySelector('#resultDetail')) {
    resultScreen.innerHTML =
      '<h2>けっか</h2>' +
      '<p id="resultText" class="result-headline"></p>' +
      '<div id="resultDetail" class="result-detail">' +
        '<section class="result-card result-card-stem">' +
          '<h3>もんだい</h3>' +
          '<div id="resultStem" class="result-stem"></div>' +
        '</section>' +
        '<section id="resultLearnerCard" class="result-card result-card-learner">' +
          '<h3>えらんだ こたえ</h3>' +
          '<div id="resultLearnerChoice" class="result-choice-list"></div>' +
        '</section>' +
        '<section id="resultCorrectCard" class="result-card result-card-correct">' +
          '<h3>せいかい</h3>' +
          '<div id="resultCorrectChoice" class="result-choice-list"></div>' +
        '</section>' +
        '<section id="resultOtherCard" class="result-card result-card-others">' +
          '<h3>ほかの せんたくし</h3>' +
          '<div id="resultOtherChoices" class="result-choice-list"></div>' +
        '</section>' +
      '</div>' +
      '<div id="reasons" class="result-reason"></div>' +
      '<div class="actions">' +
        '<button id="nextBtn" type="button">つぎの もんだい</button>' +
        '<button id="finishBtn" type="button">きょうは おしまい</button>' +
      '</div>';
  }

  resultTextEl          = document.getElementById('resultText');
  reasonsEl             = document.getElementById('reasons');
  resultDetailEl        = document.getElementById('resultDetail');
  resultStemEl          = document.getElementById('resultStem');
  resultLearnerCardEl   = document.getElementById('resultLearnerCard');
  resultLearnerChoiceEl = document.getElementById('resultLearnerChoice');
  resultCorrectCardEl   = document.getElementById('resultCorrectCard');
  resultCorrectChoiceEl = document.getElementById('resultCorrectChoice');
  resultOtherCardEl     = document.getElementById('resultOtherCard');
  resultOtherChoicesEl  = document.getElementById('resultOtherChoices');

  // 画面
  showScreen('login');

  // クリック系
  var loginBtn  = document.getElementById('loginBtn');
  startAnyBtn   = document.getElementById('startAny');
  var nextBtn   = document.getElementById('nextBtn');
  var finishBtn = document.getElementById('finishBtn');
  var homeBtn   = document.getElementById('homeBtn');

  if (loginBtn)  loginBtn.onclick  = handleLoginClick;
  if (startAnyBtn) {
    startAnyBtn.addEventListener('click', function(){
      if (domainLoadState.active) return;
      handleDomainSelection('', startAnyBtn);
    });
  }
  if (homeBtn)   homeBtn.onclick   = function(){ showScreen('home'); };

  if (choicesEl) {
    choicesEl.addEventListener('click', function(e){
      var t = e && e.target ? e.target : null;
      var btn = null;
      if (t && typeof t.closest === 'function') {
        btn = t.closest('.choice');
      } else if (t && t.parentElement && t.parentElement.classList && t.parentElement.classList.contains('choice')) {
        btn = t.parentElement;
      }
      if (!btn) return;

      var buttons = choicesEl.querySelectorAll('.choice');
      for (var i=0;i<buttons.length;i++){
        buttons[i].classList.remove('selected');
        // ★ すべて未選択に
        buttons[i].setAttribute('aria-checked','false');
      }
      btn.classList.add('selected');
      // ★ 今押したボタンだけ選択状態に
      btn.setAttribute('aria-checked','true');

      state.session.selected = btn.getAttribute('data-key');


      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-disabled');
        submitBtn.removeAttribute('aria-disabled');
        submitBtn.removeAttribute('disabled');
      }
    }, false);
  }

  if (submitBtn) {
    submitBtn.addEventListener('click', function(){
      // ★ 二重送信ガード：すでに無効なら何もしない
      if (submitBtn.disabled) return;
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitBtn.setAttribute('aria-disabled','true');

      try {
        if (!state.session.selected) { return; }
        var q = state.session.items[state.session.idx];
        if (!q) { return; }

        var elapsed = Date.now() - state.session.startedAt;
        var displayLetters = ['A','B','C','D'];
        var dispIdx = displayLetters.indexOf(state.session.selected);
        var chosenOriginal = (q.displayToOriginal && dispIdx >= 0) ? q.displayToOriginal[dispIdx] : state.session.selected;
        var correct = (chosenOriginal === q.correct);
        var correctDisplayIdx = (q.originalToDisplay && q.originalToDisplay[q.correct] != null)
          ? q.originalToDisplay[q.correct]
          : displayLetters.indexOf(q.correct);
        var correctDisplay = (correctDisplayIdx >= 0 && correctDisplayIdx < displayLetters.length)
          ? displayLetters[correctDisplayIdx]
          : '';

        var choices = [];
        for (var i = 0; i < displayLetters.length; i++) {
          choices.push({
            display: displayLetters[i],
            original: q && q.displayToOriginal ? safeGet(q.displayToOriginal, i) : displayLetters[i],
            text: safeGet(q && q.shuffledChoices, i) || ''
          });
        }
        var learnerChoice = null;
        for (var c = 0; c < choices.length; c++) {
          if (choices[c].display === state.session.selected) { learnerChoice = choices[c]; break; }
        }
        var correctChoice = (correctDisplayIdx >= 0 && correctDisplayIdx < choices.length) ? choices[correctDisplayIdx] : null;

        state.session.lastResult = {
          question: q,
          chosenDisplay: state.session.selected,
          chosenOriginal: chosenOriginal,
          correctDisplay: correctDisplay,
          correct: correct,
          choices: choices
        };

        if (resultTextEl) resultTextEl.textContent = correct ? 'せいかい！' : 'ざんねん…';

        var reasons = (q.reasons || {});
        var reason = reasons[chosenOriginal] || '';
        var why = correct ? 'よくできました！'
                          : (reason ? ('まちがえの理由：' + reason) : 'もういちど かんがえてみよう');
        if (reasonsEl) reasonsEl.textContent = why;

        if (resultDetailEl) resultDetailEl.setAttribute('data-correct', correct ? 'true' : 'false');
        if (resultStemEl) resultStemEl.innerHTML = formatUnitsHTML((q && q.stem) ? q.stem : '');

        if (resultLearnerCardEl) {
          resultLearnerCardEl.classList.remove('is-correct', 'is-incorrect');
          if (learnerChoice) {
            resultLearnerCardEl.classList.add(learnerChoice.display === correctDisplay ? 'is-correct' : 'is-incorrect');
          }
        }
        if (resultCorrectCardEl) {
          resultCorrectCardEl.classList.toggle('is-correct', !!correctChoice);
        }

        if (resultLearnerChoiceEl) {
          if (learnerChoice) {
            var learnerClasses = ['is-selected'];
            learnerClasses.push(learnerChoice.display === correctDisplay ? 'is-correct' : 'is-incorrect');
            resultLearnerChoiceEl.innerHTML = buildResultOptionHTML(learnerChoice.display, learnerChoice.text, learnerClasses);
          } else {
            resultLearnerChoiceEl.innerHTML = '<div class="result-option result-option-empty">こたえが えらばれていません</div>';
          }
        }

        if (resultCorrectChoiceEl) {
          if (correctChoice) {
            resultCorrectChoiceEl.innerHTML = buildResultOptionHTML(correctChoice.display, correctChoice.text, ['is-correct']);
          } else {
            resultCorrectChoiceEl.innerHTML = '<div class="result-option result-option-empty">せいかいが みつかりません</div>';
          }
        }

        if (resultOtherChoicesEl) {
          var otherHTML = [];
          for (var o = 0; o < choices.length; o++) {
            if (choices[o].display === correctDisplay) continue;
            if (choices[o].display === state.session.selected) continue;
            otherHTML.push(buildResultOptionHTML(choices[o].display, choices[o].text));
          }
          if (otherHTML.length > 0) {
            resultOtherChoicesEl.innerHTML = otherHTML.join('');
            if (resultOtherCardEl) resultOtherCardEl.classList.remove('is-empty');
          } else {
            resultOtherChoicesEl.innerHTML = '<div class="result-option result-option-empty">ほかの せんたくし は ありません</div>';
            if (resultOtherCardEl) resultOtherCardEl.classList.add('is-empty');
          }
        }

        showScreen('result');

        google.script.run
          .withFailureHandler(function(err){
            console.error('logResponse failed', err);
            // ★ 失敗時のみボタンを復帰
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-disabled');
            submitBtn.removeAttribute('aria-disabled');
            submitBtn.removeAttribute('disabled');
          })

          .logResponse({
            user_id: state.user_id,
            qid: q.qid,
            chosen: chosenOriginal,   // 表示レター(A/B/C/D)→元のレターに戻してログ
            correct: correct,
            elapsed_ms: elapsed,
            device: navigator.userAgent
          });

        if (correct) state.session.correctCount++;
      } catch (e) {
        console.error('submit handling error', e);
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-disabled');
        submitBtn.removeAttribute('aria-disabled');
        submitBtn.removeAttribute('disabled');
      }
    }, false);
  }

  function loadSummaryScreen(){
    var summaryEl = document.getElementById('summary');
    var streakEl = document.getElementById('summary-streak');
    var calendarEl = document.getElementById('activityCalendar');

    if (summaryEl) summaryEl.textContent = 'きょうの けっかを よみこんでいます…';
    if (streakEl) {
      streakEl.textContent = '';
    }
    if (calendarEl) {
      calendarEl.innerHTML = '';
      calendarEl.setAttribute('aria-busy', 'true');
      calendarEl.setAttribute('aria-colcount', '7');
      calendarEl.setAttribute('aria-rowcount', String(Math.ceil(DAILY_ACTIVITY_WINDOW / 7)));
    }

    google.script.run
      .withSuccessHandler(function(s){
        if (summaryEl) {
          summaryEl.innerHTML =
            'きょう（' + s.date + '）は <strong>' + s.done + '</strong> 問 といて、<strong>' + s.corrects + '</strong> 問 せいかい！';
        }
        renderPixelSummary();
        showScreen('summary');

        google.script.run
          .withSuccessHandler(function(activity){
            renderDailyActivity(activity);
          })
          .withFailureHandler(function(err){
            console.error('getDailyActivity failed', err);
            var calEl = document.getElementById('activityCalendar');
            if (calEl) calEl.removeAttribute('aria-busy');
            var streakHost = document.getElementById('summary-streak');
            if (streakHost) {
              streakHost.textContent = 'かつどうカレンダーを ひらけませんでした。';
            }
          })
          .getDailyActivity(state.user_id, DAILY_ACTIVITY_WINDOW);
      })
      .withFailureHandler(function(err){
        console.error('getTodaySummary failed', err);
        if (summaryEl) summaryEl.textContent = 'サマリーを取得できませんでした。';
        var calEl = document.getElementById('activityCalendar');
        if (calEl) calEl.removeAttribute('aria-busy');
        var streakHost = document.getElementById('summary-streak');
        if (streakHost) {
          streakHost.textContent = 'かつどうカレンダーを ひらけませんでした。';
        }
        showScreen('summary');
      })
      .getTodaySummary(state.user_id);
  }

  if (nextBtn) nextBtn.onclick = function(){
    state.session.idx++;
    if (state.session.idx >= state.session.items.length) {
      loadSummaryScreen();
    } else {
      showQuestion(); showScreen('quiz');
    }
  };

  if (finishBtn) finishBtn.onclick = function(){
    loadSummaryScreen();
  };

  // === キーボード操作 ===
  // 1〜4, A〜D で選択、Enterで送信
  document.addEventListener('keydown', function(e){
    // クイズ画面の時だけ反応
    var quizActive = document.getElementById('screen-quiz');
    if (!quizActive || !quizActive.classList.contains('active')) return;

    var mapNum = {'1':'A','2':'B','3':'C','4':'D'};
    var sel = null;
    if (mapNum[e.key]) sel = mapNum[e.key];
    else {
      var k = String(e.key||'').toUpperCase();
      if (['A','B','C','D'].indexOf(k) >= 0) sel = k;
    }

    if (sel) {
      var btn = choicesEl && choicesEl.querySelector('.choice[data-key="'+sel+'"]');
      if (btn) btn.click();
    } else if (e.key === 'Enter' && submitBtn && !submitBtn.disabled) {
      submitBtn.click();
    }
  });

}

function formatCalendarDayLabel(dateStr){
  if (!dateStr) return '';
  var parts = String(dateStr).split('-');
  if (parts.length !== 3) return dateStr;
  var month = parts[1].replace(/^0/, '');
  var day = parts[2].replace(/^0/, '');
  return month + '/' + day;
}

function buildActivityAriaLabel(dateStr, count){
  if (!dateStr) return '';
  var parts = String(dateStr).split('-');
  var label;
  if (parts.length === 3) {
    var month = parts[1].replace(/^0/, '');
    var day = parts[2].replace(/^0/, '');
    label = month + '月' + day + '日';
  } else {
    label = dateStr;
  }
  if (count > 0) {
    return label + 'は ' + count + '問 ときました';
  }
  return label + 'は おやすみでした';
}

function renderDailyActivity(activity){
  var calendarEl = document.getElementById('activityCalendar');
  var streakEl = document.getElementById('summary-streak');
  if (!calendarEl) return;

  calendarEl.innerHTML = '';
  calendarEl.removeAttribute('aria-busy');
  calendarEl.setAttribute('role', 'grid');
  calendarEl.setAttribute('aria-colcount', '7');
  calendarEl.removeAttribute('aria-rowcount');

  var days = (activity && Array.isArray(activity.days)) ? activity.days : [];
  var rows = Math.ceil(days.length / 7);
  if (rows > 0) {
    calendarEl.setAttribute('aria-rowcount', String(rows));
  }

  var totalSolved = activity && activity.totals && isFinite(activity.totals.solved)
    ? Number(activity.totals.solved) : 0;
  var streak = activity && activity.streak ? activity.streak : { current: 0, longest: 0 };

  if (streakEl) {
    var message;
    if (totalSolved > 0) {
      message = 'さいきん ' + totalSolved + '問 / れんぞく ' + streak.current + '日 (さいだい ' + streak.longest + '日)';
    } else {
      message = 'さいきんの きろくは まだ ありません。';
    }
    streakEl.textContent = message;
  }

  if (days.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'activity-calendar-empty';
    empty.setAttribute('role', 'note');
    empty.textContent = 'きろくは まだ ありません。';
    calendarEl.appendChild(empty);
    return;
  }

  var todayStr = activity && activity.window ? activity.window.end : '';

  for (var i = 0; i < days.length; i++) {
    var info = days[i] || {};
    var dateStr = info.date || '';
    var count = Number(info.count || 0);
    if (!isFinite(count)) count = 0;

    var cell = document.createElement('div');
    cell.className = 'activity-calendar-day';
    var level = 0;
    if (count >= 6) level = 4;
    else if (count >= 4) level = 3;
    else if (count >= 2) level = 2;
    else if (count >= 1) level = 1;
    cell.classList.add('level-' + level);
    if (dateStr === todayStr) {
      cell.classList.add('is-today');
      cell.setAttribute('aria-current', 'date');
    }

    cell.setAttribute('role', 'gridcell');
    cell.setAttribute('tabindex', '-1');
    var ariaLabel = buildActivityAriaLabel(dateStr, count);
    if (ariaLabel) {
      cell.setAttribute('aria-label', ariaLabel);
      cell.setAttribute('title', ariaLabel);
    }

    var labelEl = document.createElement('span');
    labelEl.className = 'activity-calendar-day-date';
    labelEl.textContent = formatCalendarDayLabel(dateStr);

    var countEl = document.createElement('span');
    countEl.className = 'activity-calendar-day-count';
    countEl.textContent = count > 0 ? String(count) : '休';

    cell.dataset.count = String(count);
    cell.appendChild(labelEl);
    cell.appendChild(countEl);
    calendarEl.appendChild(cell);
  }
}

// DOM準備後に初期化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initUI);
} else {
  initUI();
}

function renderPixelSummary(){
  var host = document.getElementById('pixelmap');
  if (!host) return;
  host.innerHTML = '';

  var cols = 16, rows = 15, total = cols * rows;
  var grid = document.createElement('div');
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = 'repeat(' + cols + ', 12px)';
  grid.style.gap = '3px';
  grid.style.marginTop = '12px';

  // まずは白マスを配置
  var cells = [];
  for (var i = 0; i < total; i++) {
    var cell = document.createElement('div');
    cell.style.width = '12px';
    cell.style.height = '12px';
    cell.style.background = '#ffffff';         // 未完了 = 白
    cell.style.border = '1px solid #e5e7eb';
    cell.style.borderRadius = '2px';
    grid.appendChild(cell);
    cells.push(cell);
  }
  host.appendChild(grid);

  // つぎに「今日やったセル」を 70% で色のせ
  google.script.run
    .withSuccessHandler(function(res){
      if (!res || !res.ok) return;
      var lv = res.levels || [];
      var n = Math.min(total, lv.length);
      for (var i = 0; i < n; i++) {
        if (lv[i] === 1) {
          cells[i].style.background = '#3b82f6'; // とりあえず青
          cells[i].style.opacity = '0.7';        // 70%（今日やった）
          cells[i].style.borderColor = '#93c5fd';
        }
      }
    })
    .withFailureHandler(function(err){ /* サイレント */ })
    .getPixelOverlayToday(state.user_id);
}
</script>
