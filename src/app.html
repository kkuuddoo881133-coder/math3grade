<script>
// ===== 画面切替（show の衝突回避で showScreen に統一） =====
function showScreen(id) {
  var S = {
    login:  document.getElementById('screen-login'),
    home:   document.getElementById('screen-home'),
    quiz:   document.getElementById('screen-quiz'),
    result: document.getElementById('screen-result'),
    summary:document.getElementById('screen-summary')
  };
  for (var k in S) { if (S[k]) S[k].classList.remove('active'); }
  if (S[id]) S[id].classList.add('active');
}

// ===== ユーティリティ =====
function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
function formatUnitsHTML(s){
  var x = escapeHTML(s);
  x = x.replace(/２/g,'2').replace(/３/g,'3').replace(/＾/g,'^');
  x = x
    .replace(/㎠/g, 'cm<sup>2</sup>')
    .replace(/㎤/g, 'cm<sup>3</sup>')
    .replace(/cm²/gi, 'cm<sup>2</sup>')
    .replace(/cm³/gi, 'cm<sup>3</sup>')
    .replace(/ｃｍ²/gi, 'cm<sup>2</sup>')
    .replace(/ｃｍ³/gi, 'cm<sup>3</sup>');
  x = x.replace(/(cm|mm|m)\s*[\^＾]\s*2/gi, '$1<sup>2</sup>')
       .replace(/(cm|mm|m)\s*[\^＾]\s*3/gi, '$1<sup>3</sup>')
       .replace(/(cm|mm|m)\s*2(?!\d)/gi, '$1<sup>2</sup>')
       .replace(/(cm|mm|m)\s*3(?!\d)/gi, '$1<sup>3</sup>');
  return x;
}
// 互換ヘルパ
function safeValue(el){ return (el && typeof el.value === 'string') ? el.value.trim() : ''; }
function safeMsg(err){ return (err && err.message) ? err.message : String(err); }
function safeGet(arr, i){ return (arr && arr.length > i && arr[i] != null) ? arr[i] : ''; }

// ===== 状態 =====
var state = {
  user_id: null, nickname: null, pin: null,
  domains: [],
  session: { items: [], idx: 0, selected: null, correctCount: 0, startedAt: 0 }
};

// === 正解位置の表示モード ===
// 'as_is'  : 並べ替えなし（シート通り。今はこれで運用）
// 'shuffle': 毎問ランダム並べ替え
// 'force_C': 表示上は常にCが正解
// 'cycle'  : A→B→C→Dと巡回で正解位置を分散
const ANSWER_POSITION_MODE = 'shuffle';

let _cycleNextIndex = 0; // cycle用カウンタ（0:A,1:B,2:C,3:D）

// 正解位置モードに応じた並べ替え（perm: 0..3 が A..D を指す）
function buildChoicePermutation(originalCorrectLetter) {
  const labels = ['A','B','C','D'];
  const correctIdx = labels.indexOf(String(originalCorrectLetter || 'A').toUpperCase());
  let perm = [0,1,2,3];

  if (ANSWER_POSITION_MODE === 'as_is') return perm;

  if (ANSWER_POSITION_MODE === 'shuffle') {
    for (let i = perm.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [perm[i], perm[j]] = [perm[j], perm[i]];
    }
    return perm;
  }

  if (ANSWER_POSITION_MODE === 'force_C') {
    const target = 2; // Cの位置
    perm = perm.filter(i => i !== correctIdx);
    perm.splice(target, 0, correctIdx);
    return perm;
  }

  if (ANSWER_POSITION_MODE === 'cycle') {
    const target = _cycleNextIndex % 4; // 0:A,1:B,2:C,3:D
    _cycleNextIndex++;
    perm = perm.filter(i => i !== correctIdx);
    perm.splice(target, 0, correctIdx);
    return perm;
  }

  return perm;
}

// 各問題に「表示↔元のレター」対応表と表示用choicesを付与
function attachChoiceMapping(q) {
  const labels = ['A','B','C','D'];
  const perm = buildChoicePermutation(q.correct);
  // 表示用選択肢
  q.shuffledChoices = perm.map(i => q.choices[i]);
  // 表示 index(0..3) → 元のレター（A..D）
  q.displayToOriginal = perm.map(i => labels[i]);
  // 元のレター（A..D）→ 表示 index(0..3)
  q.originalToDisplay = {};
  perm.forEach((i, dispIdx) => { q.originalToDisplay[labels[i]] = dispIdx; });
}


// ===== 要素参照 =====
var stemEl, assetEl, choicesEl, progressEl, skillLabelEl, submitBtn;

// ===== Login処理（堅牢・段階ログ） =====
function handleLoginClick() {
  var nicknameEl = document.getElementById('nickname');
  var pinEl = document.getElementById('pin');
  var btn = document.getElementById('loginBtn');
  var orig = btn ? btn.textContent : '';
  if (btn) { btn.disabled = true; btn.textContent = '接続中…'; }

  state.nickname = safeValue(nicknameEl) || 'guest';
  state.pin = safeValue(pinEl) || '0000';
  state.user_id = state.nickname + '#' + state.pin;
  try { localStorage.setItem('user_id', state.user_id); } catch(_){}

  var done = false;
  function finish(){
    if (done) return;
    done = true;
    if (btn) { btn.disabled = false; btn.textContent = orig; }
  }

  var watchdog = setTimeout(function(){
    try { renderDomains(); } catch(_){}
    showScreen('home');
    finish();
  }, 8000);

  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    clearTimeout(watchdog);
    finish();
    return;
  }

  google.script.run
    .withFailureHandler(function(err){
      state.domains = [];
      try { renderDomains(); } catch(e){ console.error('renderDomains error', e); }
      showScreen('home');
      var h = document.getElementById('health');
      if (h) h.textContent = 'ドメイン取得エラー: ' + safeMsg(err);
      clearTimeout(watchdog);
      finish();
    })
    .withSuccessHandler(function(domains){
      state.domains = Array.isArray(domains) ? domains : [];
      try { renderDomains(); } catch(e){ console.error('renderDomains error', e); }
      showScreen('home');

      google.script.run
        .withFailureHandler(function(err){
          console.error('healthCheck failed', err);
          var h = document.getElementById('health');
          if (h) h.textContent = '接続OK / スプレッドシートNG: ' + safeMsg(err);
        })
        .withSuccessHandler(function(info){
          var h = document.getElementById('health');
          if (h) h.textContent = '接続OK / Questions:' + info.hasQuestions + ' / Responses:' + info.hasResponses;
        })
        .healthCheck();

      clearTimeout(watchdog);
      finish();
    })
    .getDomains();
}

// ===== ドメイン読込 =====
function loadDomains() {
  google.script.run
    .withSuccessHandler(function(domains){
      state.domains = Array.isArray(domains) ? domains : [];
      try { renderDomains(); } catch (e) { console.error('renderDomains error', e); }
      showScreen('home');
    })
    .withFailureHandler(function(err){
      console.error('loadDomains failed', err);
      state.domains = [];
      try { renderDomains(); } catch(e){ console.error('renderDomains error', e); }
      showScreen('home');
    })
    .getDomains();
}

// ===== ドメイン描画 =====
function renderDomains() {
  var box = document.getElementById('domains');
  if (!box) return;
  box.innerHTML = '';
  var list = state.domains || [];
  for (var i=0;i<list.length;i++){
    var d = list[i];
    var div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = '<strong>' + escapeHTML(d) + '</strong>';
    (function(domain){
      div.onclick = function(){ startQuiz(domain); };
    })(d);
    box.appendChild(div);
  }
}

// ===== 出題〜採点 =====
function startQuiz(domain) {
  google.script.run
    .withSuccessHandler(function(items){
      state.session.items = items || [];
      (state.session.items || []).forEach(q => attachChoiceMapping(q));
      state.session.idx = 0;
      state.session.correctCount = 0;
      showQuestion();
      showScreen('quiz');
    })
    .withFailureHandler(function(err){
      console.error('getQuestions failed', err);
    })
    // ★ 認可に必要な user_id を必ず渡す
    .getQuestions({ domain: domain, limit: 50, order: 'sequential', user_id: state.user_id });
}

function showQuestion() {
  var q = state.session.items[state.session.idx];
  if (!q) { return; }

  state.session.selected = null;
  state.session.startedAt = Date.now();

  if (progressEl)    progressEl.textContent = (state.session.idx + 1) + ' / ' + state.session.items.length;
  if (skillLabelEl)  skillLabelEl.textContent = 'スキル：' + (q && q.skill ? q.skill : '');
  if (stemEl)        stemEl.innerHTML = formatUnitsHTML((q && q.stem) ? q.stem : '');
  renderAsset(q ? q.assets : '');

  if (choicesEl) {
    choicesEl.innerHTML = '';
    var keys = ['A','B','C','D'];
    for (var i=0;i<4;i++){
      var key = keys[i];
      var text = formatUnitsHTML(safeGet(q && q.shuffledChoices, i) || '');
      var btn = document.createElement('button');
      btn.className = 'choice';
      btn.type = 'button';
      btn.setAttribute('data-key', key);
      // ★ ARIA：ラジオボタン相当の意味付け
      btn.setAttribute('role', 'radio');
      btn.setAttribute('aria-checked', 'false');
      btn.innerHTML = '(' + key + ') ' + text;
      choicesEl.appendChild(btn);
    }
  }

  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-disabled');
    submitBtn.setAttribute('aria-disabled', 'true');
  }
}

// ===== アセット描画 =====
function renderAsset(id) {
  if (!assetEl) return;
  var rawId = String(id || '').trim();
  assetEl.innerHTML = '';
  if (!rawId) return;

  var normalized = rawId.replace(/：/g, ':').replace(/[－ー]/g, '-').toLowerCase();
  if (!normalized) return;

  function normalizeImageUrl(raw){
    var url = String(raw || '').trim();
    if (url.toLowerCase().indexOf('img:') === 0) url = url.slice(4).trim();

    if (/^(data:|https?:\/\/)/i.test(url)) {
      var m = url.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//i);
      if (m && m[1]) return 'https://drive.google.com/uc?export=view&id=' + m[1];
      return url;
    }
    var g = url.match(/^gdrive:([\w-]+)$/i);
    if (g && g[1]) return 'https://drive.google.com/uc?export=view&id=' + g[1];
    return url; // 相対パス等
  }

  // --- 追加：モジュール化されたSVGレンダラーを先に試す ---
  if (normalized.indexOf('svg:') === 0 && window.SVG && Array.isArray(window.SVG._renderers)) {
    var spec = normalized.slice(4);
    for (var i = 0; i < window.SVG._renderers.length; i++) {
      try {
        var node = window.SVG._renderers[i](spec);
        if (node) { assetEl.appendChild(node); return; }
      } catch(e) { /* 個別レンダラーの例外は握りつぶし */ }
    }
  }
  // --- ここまで ---
  if (normalized.indexOf('img:') === 0) {
    var raw = rawId.slice(4).trim(); // 大文字ラベル保持
    var url = normalizeImageUrl(raw);

    var img = document.createElement('img');
    img.src = url;
    img.alt = '図';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '8px 0';
    img.onerror = function(){
      var note = document.createElement('div');
      note.textContent = '画像を読み込めませんでした：' + url;
      note.style.fontSize = '0.9em';
      note.style.color = '#b00';
      assetEl.innerHTML = '';
      assetEl.appendChild(note);
    };
    assetEl.appendChild(img);
  }
}



// ===== 初期化 =====
function initUI() {
  // 要素参照
  stemEl       = document.getElementById('stem');
  assetEl      = document.getElementById('asset');
  choicesEl    = document.getElementById('choices');
  progressEl   = document.getElementById('progress');
  skillLabelEl = document.getElementById('skillLabel');
  submitBtn    = document.getElementById('submitBtn');

  // 画面
  showScreen('login');

  // クリック系
  var loginBtn  = document.getElementById('loginBtn');
  var startAny  = document.getElementById('startAny');
  var nextBtn   = document.getElementById('nextBtn');
  var finishBtn = document.getElementById('finishBtn');
  var homeBtn   = document.getElementById('homeBtn');

  if (loginBtn)  loginBtn.onclick  = handleLoginClick;
  if (startAny)  startAny.onclick  = function(){ startQuiz(''); };
  if (homeBtn)   homeBtn.onclick   = function(){ showScreen('home'); };

  if (choicesEl) {
    choicesEl.addEventListener('click', function(e){
      var t = e && e.target ? e.target : null;
      var btn = null;
      if (t && typeof t.closest === 'function') {
        btn = t.closest('.choice');
      } else if (t && t.parentElement && t.parentElement.classList && t.parentElement.classList.contains('choice')) {
        btn = t.parentElement;
      }
      if (!btn) return;

      var buttons = choicesEl.querySelectorAll('.choice');
      for (var i=0;i<buttons.length;i++){
        buttons[i].classList.remove('selected');
        // ★ すべて未選択に
        buttons[i].setAttribute('aria-checked','false');
      }
      btn.classList.add('selected');
      // ★ 今押したボタンだけ選択状態に
      btn.setAttribute('aria-checked','true');

      state.session.selected = btn.getAttribute('data-key');


      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-disabled');
        submitBtn.removeAttribute('aria-disabled');
        submitBtn.removeAttribute('disabled');
      }
    }, false);
  }

  if (submitBtn) {
    submitBtn.addEventListener('click', function(){
      // ★ 二重送信ガード：すでに無効なら何もしない
      if (submitBtn.disabled) return;
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitBtn.setAttribute('aria-disabled','true');

      try {
        if (!state.session.selected) { return; }
        var q = state.session.items[state.session.idx];
        if (!q) { return; }

        var elapsed = Date.now() - state.session.startedAt;
        var dispIdx = ['A','B','C','D'].indexOf(state.session.selected);
        var chosenOriginal = (q.displayToOriginal && dispIdx >= 0) ? q.displayToOriginal[dispIdx] : state.session.selected;
        var correct = (chosenOriginal === q.correct);

        document.getElementById('resultText').textContent = correct ? 'せいかい！' : 'ざんねん…';

        var reasons = (q.reasons || {});
        var reason = reasons[chosenOriginal] || '';
        var why = correct ? 'よくできました！'
                          : (reason ? ('まちがえの理由：' + reason) : 'もういちど かんがえてみよう');
        document.getElementById('reasons').textContent = why;

        showScreen('result');

        google.script.run
          .withFailureHandler(function(err){
            console.error('logResponse failed', err);
            // ★ 失敗時のみボタンを復帰
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-disabled');
            submitBtn.removeAttribute('aria-disabled');
            submitBtn.removeAttribute('disabled');
          })

          .logResponse({
            user_id: state.user_id,
            qid: q.qid,
            chosen: chosenOriginal,   // 表示レター(A/B/C/D)→元のレターに戻してログ
            correct: correct,
            elapsed_ms: elapsed,
            device: navigator.userAgent
          });

        if (correct) state.session.correctCount++;
      } catch (e) {
        console.error('submit handling error', e);
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-disabled');
        submitBtn.removeAttribute('aria-disabled');
        submitBtn.removeAttribute('disabled');
      }
    }, false);
  }

  if (nextBtn) nextBtn.onclick = function(){
    state.session.idx++;
    if (state.session.idx >= state.session.items.length) {
      google.script.run
        .withSuccessHandler(function(s){
          document.getElementById('summary').innerHTML =
            'きょう（' + s.date + '）は <strong>' + s.done + '</strong> 問 といて、<strong>' + s.corrects + '</strong> 問 せいかい！';
          renderPixelSummary();
          showScreen('summary');
        })
        .withFailureHandler(function(err){
          console.error('getTodaySummary failed', err);
          document.getElementById('summary').textContent = 'サマリーを取得できませんでした。';
          showScreen('summary');
        })
        .getTodaySummary(state.user_id);
    } else {
      showQuestion(); showScreen('quiz');
    }
  };

  if (finishBtn) finishBtn.onclick = function(){
    google.script.run
      .withSuccessHandler(function(s){
        document.getElementById('summary').innerHTML =
          'きょう（' + s.date + '）は <strong>' + s.done + '</strong> 問 といて、<strong>' + s.corrects + '</strong> 問 せいかい！';
        renderPixelSummary();
        showScreen('summary');
      })
      .withFailureHandler(function(err){
        console.error('getTodaySummary failed', err);
        document.getElementById('summary').textContent = 'サマリーを取得できませんでした。';
        showScreen('summary');
      })
      .getTodaySummary(state.user_id);
  };

  // === キーボード操作 ===
  // 1〜4, A〜D で選択、Enterで送信
  document.addEventListener('keydown', function(e){
    // クイズ画面の時だけ反応
    var quizActive = document.getElementById('screen-quiz');
    if (!quizActive || !quizActive.classList.contains('active')) return;

    var mapNum = {'1':'A','2':'B','3':'C','4':'D'};
    var sel = null;
    if (mapNum[e.key]) sel = mapNum[e.key];
    else {
      var k = String(e.key||'').toUpperCase();
      if (['A','B','C','D'].indexOf(k) >= 0) sel = k;
    }

    if (sel) {
      var btn = choicesEl && choicesEl.querySelector('.choice[data-key="'+sel+'"]');
      if (btn) btn.click();
    } else if (e.key === 'Enter' && submitBtn && !submitBtn.disabled) {
      submitBtn.click();
    }
  });

}

// DOM準備後に初期化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initUI);
} else {
  initUI();
}

function renderPixelSummary(){
  var host = document.getElementById('pixelmap');
  if (!host) return;
  host.innerHTML = '';

  var cols = 16, rows = 15, total = cols * rows;
  var grid = document.createElement('div');
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = 'repeat(' + cols + ', 12px)';
  grid.style.gap = '3px';
  grid.style.marginTop = '12px';

  // まずは白マスを配置
  var cells = [];
  for (var i = 0; i < total; i++) {
    var cell = document.createElement('div');
    cell.style.width = '12px';
    cell.style.height = '12px';
    cell.style.background = '#ffffff';         // 未完了 = 白
    cell.style.border = '1px solid #e5e7eb';
    cell.style.borderRadius = '2px';
    grid.appendChild(cell);
    cells.push(cell);
  }
  host.appendChild(grid);

  // つぎに「今日やったセル」を 70% で色のせ
  google.script.run
    .withSuccessHandler(function(res){
      if (!res || !res.ok) return;
      var lv = res.levels || [];
      var n = Math.min(total, lv.length);
      for (var i = 0; i < n; i++) {
        if (lv[i] === 1) {
          cells[i].style.background = '#3b82f6'; // とりあえず青
          cells[i].style.opacity = '0.7';        // 70%（今日やった）
          cells[i].style.borderColor = '#93c5fd';
        }
      }
    })
    .withFailureHandler(function(err){ /* サイレント */ })
    .getPixelOverlayToday(state.user_id);
}
</script>
