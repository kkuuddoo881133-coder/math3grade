<!-- src/svg_scale.html -->
<script>
/* ==============================================
 * バネばかり／選択メーター／てんびん  アセット
 * 依存: window.SVG  (共通ヘルパ)
 * ============================================== */
(function (SVG) {

  /* ---------- 汎用：円弧メーター描画 ---------- */
  function renderScale(opts){
    // max: 最大値[g] (1000/2000 など)
    // step: 目盛1本あたり[g] (20/50 など)
    // value: 針の値[g]
    // unitLabel: ラベル (例 "g")
    var W = opts.width  || 240;
    var H = opts.height || 170;
    var svg = SVG.svg(W, H);

    var cx = W/2, cy = H-12;                 // 半円の中心（下）
    var R  = Math.min(W*0.42, H*0.75);       // 半径
    var max = opts.max, step = opts.step;
    var value = Math.max(0, Math.min(max, (opts.value||0)));

    // 枠
    svg.appendChild(SVG.el('rect', {
      x:10, y:10, width:W-20, height:H-20, rx:10, ry:10,
      fill:'#fff', stroke:'#374151', 'stroke-width':1.4
    }));

    // 目盛（-90°〜+90°）
    var totalTicks = Math.round(max/step);
    for (var i=0; i<=totalTicks; i++){
      var ratio = i/totalTicks;                      // 0..1
      var ang = (-Math.PI/2) + (Math.PI * ratio);
      var len = 8;
      // 強調：100g毎 or 200g毎（最大値で切替）
      var g = i*step;
      if ( (max===1000 && g%100===0) || (max===2000 && g%200===0) ) len = 13;

      var x1 = cx + Math.cos(ang) * (R-18);
      var y1 = cy + Math.sin(ang) * (R-18);
      var x2 = cx + Math.cos(ang) * (R-18-len);
      var y2 = cy + Math.sin(ang) * (R-18-len);
      svg.appendChild(SVG.el('line', {x1:x1,y1:y1,x2:x2,y2:y2, stroke:'#111'}));

      // 主要ラベル
      var showMajor = (max===1000 && g%200===0) || (max===2000 && g%500===0) || (g===0) || (g===max);
      if (showMajor){
        var lx = cx + Math.cos(ang) * (R-36);
        var ly = cy + Math.sin(ang) * (R-36) + 4;
        var text = (max===2000 && g%1000===0) ? (g/1000)+'kg'
                  : (g===0? '0' : g+'g');
        svg.appendChild(SVG.text(lx, ly, text, {'font-size':11, fill:'#111', 'text-anchor':'middle'}));
      }
    }

    // 針
    var angV = (-Math.PI/2) + Math.PI * (value/max);
    var nx = cx + Math.cos(angV) * (R-30);
    var ny = cy + Math.sin(angV) * (R-30);
    svg.appendChild(SVG.el('line', {
      x1:cx, y1:cy, x2:nx, y2:ny, stroke:'#2563eb', 'stroke-width':3
    }));
    // ハブ
    svg.appendChild(SVG.el('circle', {cx:cx, cy:cy, r:5, fill:'#2563eb'}));

    // 下センターに数値（オプションで非表示可）
    if (opts.showValue !== false){
      var label = (max>=2000 && value%1000===0) ? (value/1000)+'kg' : (value+'g');
      svg.appendChild(SVG.text(cx, H-26, label, {'font-size':12, fill:'#374151', 'text-anchor':'middle'}));
    }
    return svg;
  }

  /* ---------- 4択：小型メーター横並び ---------- */
  function renderScalePick(conf){
    // {max, step, correct, deltas:[-20,+20,...]} など
    var W = conf.width || 560, H = conf.height || 170, gap = 14;
    var cols = 4, cardW = (W - gap*(cols+1)) / cols, cardH = H-40;
    var svg = SVG.svg(W, H);
    var choices = ['ア','イ','ウ','エ'];

    // 針の値を作る（正解 + 典型ミス）
    var values = [
      conf.correct + (conf.deltas?.[0] ?? 0),
      conf.correct + (conf.deltas?.[1] ?? 0),
      conf.correct + (conf.deltas?.[2] ?? 0),
      conf.correct + (conf.deltas?.[3] ?? 0),
    ];

    for (var i=0;i<4;i++){
      var x = gap + i*(cardW+gap), y=14;
      // 台
      svg.appendChild(SVG.el('rect', {x:x, y:y, width:cardW, height:cardH, rx:10, ry:10, fill:'#fff'}));
      // 小メーター
      var s = renderScale({width:cardW-16, height:cardH-30, max:conf.max, step:conf.step, value:values[i], showValue:false});
      s.setAttribute('x', x+8);
      s.setAttribute('y', y+6);
      svg.appendChild(s);
      // ラベル
      svg.appendChild(SVG.text(x + cardW/2, y + cardH - 6, choices[i],
        {'font-size':14, fill:'#2563eb', 'text-anchor':'middle'}));
    }
    return svg;
  }

  /* ---------- てんびん ---------- */
  function renderBalanceTilt(opts){
    // opts.diffCoins = 3 なら右が軽い図（→右へ3こ置けば釣り合う）
    var W = opts.width||420, H = opts.height||160;
    var svg = SVG.svg(W,H);

    var cx=W/2, baseY=H-26;

    // 支点（三角）
    svg.appendChild(SVG.el('path', {d:`M ${cx-16} ${baseY} L ${cx} ${baseY-24} L ${cx+16} ${baseY} Z`, fill:'#9ca3af'}));

    // ビーム（傾き）
    var tilt = (opts.rightIsLight!==false) ? -10 : 10; // 右が軽い→右上がる→ビーム左下がり（負）
    var beamLen = W*0.7;
    svg.appendChild(SVG.el('rect', {
      x:cx-beamLen/2, y:baseY-70, width:beamLen, height:6,
      transform:`rotate(${tilt} ${cx} ${baseY-67})`,
      rx:3, ry:3, fill:'#374151'
    }));

    // 皿
    function pan(cx0, up){
      var y = baseY-40 + (up? -14: 14);
      var g = SVG.el('g', {});
      g.appendChild(SVG.el('line',{x1:cx0,y1:baseY-64,x2:cx0,y2:y-6,stroke:'#374151'}));
      g.appendChild(SVG.el('rect',{x:cx0-42,y:y,width:84,height:10,rx:5,ry:5,fill:'#e5e7eb',stroke:'#374151'}));
      return g;
    }
    var leftUp  = (tilt>0);   // ビーム右下がり→左上がる
    var rightUp = (tilt<0);
    var left = pan(cx-beamLen/2+36, leftUp);
    var right= pan(cx+beamLen/2-36, rightUp);
    svg.appendChild(left); svg.appendChild(right);

    // ラベル（ア/イ）
    svg.appendChild(SVG.text(cx-beamLen/2+36, baseY-12, 'ア', {'font-size':14, fill:'#2563eb', 'text-anchor':'middle'}));
    svg.appendChild(SVG.text(cx+beamLen/2-36, baseY-12, 'イ', {'font-size':14, fill:'#2563eb', 'text-anchor':'middle'}));

    // 注記（右に3こ置けば釣り合う）
    if (opts.diffCoins){
      svg.appendChild(SVG.text(W-8, 18, `右に${opts.diffCoins}こ のせる`, {'font-size':12, fill:'#374151', 'text-anchor':'end'}));
    }
    return svg;
  }

  /* ---------- レジストリ ---------- */
  function parse(spec){
    // scale-1k-20-340 / scale-2k-50-1200
    var m1 = spec.match(/^(:?svg:)?scale-(1k|2k)-(\d+)-(\d+)$/);
    if (m1) return {kind:'scale', max:(m1[2]==='1k'?1000:2000), step:+m1[3], value:+m1[4]};

    // scale-pick-1k-20-430 など
    var m2 = spec.match(/^(:?svg:)?scale-pick-(1k|2k)-(\d+)-(\d+)$/);
    if (m2) return {kind:'pick', max:(m2[2]==='1k'?1000:2000), step:+m2[3], correct:+m2[4]};

    // balance-tilt-3
    var m3 = spec.match(/^(:?svg:)?balance-tilt-(\d+)$/);
    if (m3) return {kind:'balance', diff:+m3[2]};

    return null;
  }

  SVG.register(function(spec){
    var p = parse(spec);
    if (!p) return null;

    if (p.kind==='scale'){
      return renderScale({max:p.max, step:p.step, value:p.value});
    }

    if (p.kind==='pick'){
      // デフォの4択パターン（典型誤答）：[-40, +40, 0, -80]（1k/20g用）
      var delta40 = (p.step===50) ? 100 : 40; // 2kg/50gなら±100gに
      var deltas = [-delta40, +delta40, 0, -(delta40*2)];
      return renderScalePick({max:p.max, step:p.step, correct:p.correct, deltas:deltas});
    }

    if (p.kind==='balance'){
      return renderBalanceTilt({diffCoins:p.diff, rightIsLight:true});
    }
    return null;
  });

})(window.SVG);
</script>
